### Preventing Buffer Overflows With Canaries & NX

##### Canaries

Canary is a compiler defence mechanism
Whenever a stack frame gets created, compiler would insert canary in the stack
Canary is just a random number

![alt text](1.png)

From the image, if any of the 2 buffers, that is buffer1 or buffer2 overflows and it crosses the canary then the canary value will be modified
At the end of function the compiler compares canries original and current value and if it is different program throws a `stack smashing detected` error
If canary present, function prologue and epilogue changes a bit
Canaries can be added using `-fstack-protector`
If `-fstack-protector` specified, canaries will be added based on gcc heuristic

- For example, buffer of size at-least 8 bytes is allocated

In gcc 4.4.5 canaries are not added by default so need to give the `-fstack-protector` flag

![alt text](2.png)

![alt text](3.png)

Total of 5 extra instructions get added if canary is present, 3 at the beginning and 2 at the end to compare original and current value, this check done using `xor` operation, the result of xor is passed to `je` instruction which means jump if equal to certain value and if it is equal, it jumps to an inbuilt function called `stack_chk_fail`

##### Non Executable Stack(NX)(W^X bit)

Implemented in the hardware by the processor manufacturer
W^X(W XOR X) : mean one can either write to a segment or execute the segment
If we can write, them `W` bit becomes 1 so to keep XOR 1 the `X` bit becomes 0
In shellcode injection, we first wrote to the stack then executed it now with th NX enabled, one of those 2 is not possible
Called `DEP` : `Data Execution Prevention`

Does not work for some programs that need to execute from the stack that NEED to execute from the stack

- Example : JIT compiler, constructs assembly code from external data then execute it(Need to disable W^X bit to make this work)
